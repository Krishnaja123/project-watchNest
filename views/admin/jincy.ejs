<%- include("../../views/partials/admin/header") %>

    <head>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.css">
    </head>

    <style>
        .content-main {
            display: flex;
            justify-content: center;
            padding-top: 50px;
        }

        .card {
            width: 100%;
            max-width: 900px;
            margin-bottom: 20px;
        }

        .preview-img {
            margin-top: 10px;
            max-width: 150px;
            max-height: 150px;
            border: 1px solid #ddd;
            border-radius: 6px;
            display: block;
        }

        .image-cropper {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
    </style>






    <section class="content-main">
        <div class="col-lg-12">
            <div class="card mb-4">
                <div class="card-body">
                    <h2 class="content-title mb-4 text-center">Edit Product</h2>
                    <% if (success && success.length> 0) { %>
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <%= success[0] %>
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                        <% } %>

                            <% if (error && error.length> 0) { %>
                                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                    <%= error[0] %>
                                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                                </div>
                                <% } %>

                                    <form id="productForm"
                                        action="/admin/products/<%= product._id %>/variant/<%= variant._id %>/size/<%= size._id %>/edit"
                                        method="POST" enctype="multipart/form-data">

                                        <!-- Basic Product Info -->
                                        <div class="mb-3">
                                            <label class="form-label">Product Name</label>
                                            <input type="text" class="form-control" name="product_name"
                                                value="<%= product.product_name %>" id="name">
                                            <div class="text-danger small mt-1" id="nameError"></div>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Description</label>
                                            <textarea class="form-control" name="product_description" rows="3"
                                                id="description"><%= product.product_description %></textarea>
                                            <div class="text-danger small mt-1" id="descriptionError"></div>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Category</label>
                                            <select class="form-select" name="category" id="category">
                                                <% categories.forEach(cat=> { %>
                                                    <option value="<%= cat._id %>" <%=product.category_id &&
                                                        product.category_id._id &&
                                                        product.category_id._id.toString()===cat._id.toString()
                                                        ? 'selected' : '' %>>
                                                        <%= cat.category_name || cat.name %>
                                                    </option>
                                                    <% }) %>
                                            </select>
                                            <div class="text-danger small mt-1" id="categoryError"></div>
                                        </div>

                                        <hr>
                                        <h4 class="mb-3 text-primary">Variant Details</h4>

                                        <!-- Variant Info -->
                                        <div class="mb-3">
                                            <label class="form-label">Color</label>
                                            <input type="text" class="form-control" name="color" id='color'
                                                value="<%= variant.color %>">
                                            <div class="text-danger small mt-1" id="colorError"></div>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Price</label>
                                            <input type="number" class="form-control" name="price" id='price'
                                                value="<%= variant.price %>">
                                            <div class="text-danger small mt-1" id="priceError"></div>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Discount Price</label>
                                            <input type="number" class="form-control" name="discount_price"
                                                id='discountPrice' value="<%= variant.discount_price %>">
                                            <div class="text-danger small mt-1" id="discountPriceError"></div>
                                        </div>

                                        <hr>
                                        <h4 class="mb-3 text-success">Selected Size</h4>

                                        <!-- Size Info -->
                                        <div class="mb-3">
                                            <label class="form-label">Size</label>
                                            <input type="text" class="form-control" name="size" id="size"
                                                value="<%= size.size %>">
                                            <div class="text-danger small mt-1" id="sizeError"></div>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">Stock</label>
                                            <input type="number" class="form-control" name="stock" id="stock"
                                                value="<%= size.stock %>">
                                            <div class="text-danger small mt-1" id="stockError"></div>
                                        </div>

                                        <!-- Image Upload and Cropping -->
                                        <hr>
                                        <h4 class="mb-3 text-warning">Variant Images</h4>
                                        <div class="mb-3">
                                            <div id="variantImages" class="d-flex flex-wrap gap-3">
                                                <% for (let i=0; i < 4; i++) { %>
                                                    <div>
                                                        <input type="file" class="form-control" id="input<%= i %>"
                                                            accept="image/*" name="originalImages">
                                                        <img id="imgView<%= i %>" class="preview-img"
                                                            src="<%= variant.images && variant.images[i] ? variant.images[i] : '' %>"
                                                            alt="Product Image">
                                                        <div id="cropperContainer<%= i %>" class="image-cropper">
                                                            <img src="<%= variant.images && variant.images[i] ? variant.images[i] : '' %>"
                                                                id="croppedImg<%= i %>">
                                                            <button type="button" class="btn btn-sm btn-primary"
                                                                id="saveButton<%= i %>">Save Crop</button>
                                                        </div>
                                                    </div>
                                                    <% } %>
                                            </div>
                                            <div class="text-danger small mt-1" id="imageError"></div>
                                        </div>

                                        <div class="text-center mt-4">
                                            <button class="btn btn-success" type="submit">Update Product</button>
                                            <a href="/admin/products" class="btn btn-secondary">Cancel</a>
                                        </div>

                                    </form>
                </div>
            </div>
        </div>
    </section>

    <%- include("../../views/partials/admin/footer") %>

        <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.js"></script>

        <script>

            document.addEventListener("DOMContentLoaded", function () {
                const croppedImagesData = {};

                for (let i = 0; i < 4; i++) {
                    const inputEl = document.getElementById(`input${i}`);
                    const previewEl = document.getElementById(`imgView${i}`);
                    const cropperImg = document.getElementById(`croppedImg${i}`);
                    const cropperContainer = document.getElementById(`cropperContainer${i}`);
                    const saveBtn = document.getElementById(`saveButton${i}`);
                    let cropper;

                    // Show cropper when image selected
                    inputEl.addEventListener("change", (e) => {
                        const file = e.target.files[0];
                        if (!file) return;
                        const reader = new FileReader();
                        reader.onload = function (event) {
                            cropperImg.src = event.target.result;
                            cropperContainer.style.display = "flex";
                            if (cropper) cropper.destroy();
                            cropper = new Cropper(cropperImg, {
                                aspectRatio: 1,
                                viewMode: 1,
                                autoCropArea: 1,
                                movable: true,
                                scalable: true,
                                zoomable: true,
                                rotatable: true,
                                dragMode: 'crop',
                                responsive: true
                            });
                        };
                        reader.readAsDataURL(file);
                    });

                    // Save cropped image
                    saveBtn.addEventListener("click", () => {
                        if (!cropper) return;
                        const canvas = cropper.getCroppedCanvas({ width: 500, height: 500 });
                        canvas.toBlob((blob) => {
                            const url = URL.createObjectURL(blob);
                            previewEl.src = url;
                            cropperContainer.style.display = "none";
                            croppedImagesData[i] = blob;
                        }, "image/jpeg", 0.9);
                    });
                }

                function validateForm() {
                    let valid = true
                    const name = document.getElementById('name').value.trim()
                    const description = document.getElementById('description').value.trim()
                    const category = document.getElementById('category').value.trim()
                    const color = document.getElementById('color').value.trim()
                    const price = document.getElementById('price').value.trim()
                    const discountPrice = document.getElementById('discountPrice').value.trim()
                    const size = document.getElementById('size').value.trim()
                    const stock = document.getElementById('stock').value.trim()

                    document.getElementById('nameError').textContent = ''
                    document.getElementById('descriptionError').textContent = ''
                    document.getElementById('categoryError').textContent = ''
                    document.getElementById('colorError').textContent = ''
                    document.getElementById('priceError').textContent = ''
                    document.getElementById('discountPriceError').textContent = ''
                    document.getElementById('sizeError').textContent = ''
                    document.getElementById('stockError').textContent = ''
                    document.getElementById('imageError').textContent = ''


                    if (!name) {
                        document.getElementById('nameError').textContent = 'Product name is required'
                        valid = false
                    }
                    else if (name.length < 3) {
                        document.getElementById('nameError').textContent = "Name must be at least 3 characters";
                        valid = false;
                    }
                    else if (!/^[a-zA-Z0-9\s]+$/.test(name)) {
                        document.getElementById('nameError').textContent = "Product name must not contain special characters";
                        valid = false;
                    }
                    if (!description) {
                        document.getElementById('descriptionError').textContent = 'Description is required';
                        valid = false;
                    }
                    else if (description.length < 10) {
                        document.getElementById('descriptionError').textContent = 'Description must be at least 10 characters';
                        valid = false;
                    }

                    if (!category) {
                        document.getElementById('categoryError').textContent = "Please select a category";
                        valid = false;
                    }
                    if (!price || Number(price) <= 0) {
                        document.getElementById('priceError').textContent = 'Price must be grater than 0'
                        valid = false
                    }
                    if (discountPrice && (Number(discountPrice) > Number(price) || Number(discountPrice) < 0)) {
                        document.getElementById('discountPriceError').textContent = "Invalid discount price";
                        valid = false;
                    }
                    if (!stock || Number(stock) < 0) {
                        document.getElementById('stockError').textContent = "Invalid stock";
                        valid = false;
                    }
                    if (!color || !/^[A-Za-z\s]+$/.test(color)) {
                        document.getElementById('colorError').textContent = "Invalid color";
                        valid = false;
                    }
                    if (!size || isNaN(size) || Number(size) < 6 || Number(size) > 10) {
                        document.getElementById('sizeError').textContent = "Size must be 6-10";
                        valid = false;
                    }

                    let imageCount = 0;
                    for (let i = 0; i < 4; i++) {
                        const img = document.getElementById(`imgView${i}`);
                        if (img && img.src) imageCount++;
                    }
                    if (imageCount !== 4) {
                        document.getElementById('imageError').textContent = 'Please upload 4 images';
                        valid = false;
                    }
                    return valid
                }

                document.getElementById('productForm').addEventListener('submit', async (e) => {
                    console.log("Submit button clicked!");
                    if (!validateForm()) {
                        e.preventDefault()
                        return
                    }
                    e.preventDefault()
                    const form = e.target
                    const formData = new FormData(form)
                    for (let i = 0; i < 4; i++) {
                        const fileInput = document.getElementById(`input${i}`);
                        if (fileInput && fileInput.files.length > 0) {
                            formData.append("originalImages", fileInput.files[0]);
                        }
                    }


                    Object.keys(croppedImagesData).forEach((key, index) => {
                        formData.append('croppedImagesData', croppedImagesData[key], `image_${index}.jpg`);
                    });

                    try {
                        const response = await fetch(form.action, {
                            method: "POST",
                            body: formData,
                        });


                        if (response.ok) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Success!',
                                text: 'Product updated successfully!',
                                confirmButtonColor: '#28a745'
                            }).then(() => {
                                window.location.href = "/admin/products";
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Oops!',
                                text: 'Failed to update product. Please try again.',
                                confirmButtonColor: '#d33'
                            });
                        }

                    } catch (error) {
                        console.log(error.message);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error!',
                            text: 'Something went wrong while updating the product.',
                            confirmButtonColor: '#d33'
                        });
                    }
                })

            })

        </script>