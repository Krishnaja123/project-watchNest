<!-- views/category.ejs -->
 <%- include("../partials/admin/header") %>

    <head>
        <link rel="stylesheet" href="/css/admin/sidebar.css">
        <link rel="stylesheet" href="/css/admin/admin.css">

    </head>

    <body>
        <div class="container">
            <!-- Sidebar -->
            <%- include("../partials/admin/sidebar") %>

                <!-- Main Content -->
                <div class="main">
                    <h1>Categories</h1>

                    <div class="top-bar">
                        <button id="add-category">+ Add Product</button>

                        <div class="search-box">
                            <input type="text" placeholder="Search" id="search">
                            <button type="button" id="clear-btn">&times;</button>
                        </div>
                    </div>

                    <!-- Table -->
                    <div class="table-container">
                        <table id="table">
                            <thead id="thead">
                                <tr>
                                    <th>Id</th>
                                    <th>Name</th>
                                    <th>View</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="tbody"></tbody>
                        </table>
                    </div>

                    <div class="pagination"></div>
                </div>
        </div>
    </body>

    <%- include("../partials/admin/footer") %>

        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const message = "<%= message %>";
                const type = "<%= type %>";
                if (message) {
                    Swal.fire({
                        icon: type,
                        text: message,
                        confirmButtonColor: '#007bff'
                    });
                }

                const addCategory = document.getElementById("add-category");
                addCategory.addEventListener("click", function () {
                    window.location.href = "/admin/category";
                })
                const searchInput = document.getElementById("search");
                const clearBtn = document.getElementById("clear-btn");

                searchInput.addEventListener("input", function () {
                    clearBtn.style.display = searchInput.value ? "inline" : "none";
                })

                clearBtn.addEventListener("click", function () {
                    searchInput.value = "";
                    clearBtn.style.display = "none";
                    searchInput.focus();
                    fetchCategory();
                })
                let page = "<%= page %>";
                console.log("page :", page);

                fetchCategory(page);

                searchInput.addEventListener("input", function (e) {
                    let searchValue = e.target.value;
                    fetchCategory(1, searchValue);
                })

                const tbody = document.getElementById("tbody");
                tbody.addEventListener("click", function (e) {
                    if (e.target && e.target.classList.contains("btn-delete")) {
                        e.preventDefault();
                        //console.log("clicked delete button");

                        const categoryId = e.target.getAttribute("data-id");
                        const page = e.target.getAttribute("data-page");
                        console.log(categoryId);

                        if (window.confirm("Are you sure you want to delete this?")) {
                            console.log("entered into the confirmation block");

                            deleteCategory(categoryId, page);
                        } else {
                            Swal.fire({
                                text: 'Delete canceled'
                            });
                        }
                    }
                })

                async function fetchCategory(page = 1, search = "") {
                    try {
                        const response = await fetch(`/admin/fetchCategories?page=${page}&search=${search}`);
                        console.log("response from fetchCategory: ", response);

                        if (!response.ok) {
                            throw new Error("Network response was not ok");
                        }
                        const data = await response.json();
                        //console.log("data", data);

                        await renderCategories(data.categories, data.currentPage);
                        console.log("1")
                        renderPagination(data.totalPages, data.currentPage);

                    } catch (error) {
                        console.log("Error fetching categories:", error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Failed to load categories'
                        });
                    }
                }

                function renderCategories(categories, currentPage) {
                    const tbody = document.getElementById("tbody");
                    tbody.innerHTML = "";

                    categories.forEach(category => {
                        const tr = document.createElement("tr");

                        const cells = [
                            category._id,
                            category.name
                        ]
                        cells.forEach(data => {
                            const td = document.createElement("td");
                            td.textContent = data;
                            tr.appendChild(td);
                        });

                        const td = document.createElement("td");
                        const viewBtn = document.createElement("button");
                        viewBtn.textContent = category.view ? "Listed" : "Unlisted";

                        viewBtn.className = category.view ? "btn btn-listed" : "btn btn-unlisted";
                        viewBtn.setAttribute("data-id", category._id);
                        td.appendChild(viewBtn);
                        tr.appendChild(td);

                        viewBtn.addEventListener("click", async function () {
                            const response = await fetch(`/admin/viewCategory/${category._id}`, { method: "PUT" });
                            if (!response.ok) {
                                throw new Error("Network response was not ok");

                            }
                            const data = await response.json();
                            if (data.view) {
                                viewBtn.textContent = "Listed";
                                viewBtn.className = "btn btn-listed";
                            } else {
                                viewBtn.textContent = "Unlisted";
                                viewBtn.className = "btn btn-unlisted";
                            }
                        })

                        const actionTd = document.createElement("td");
                        const editLink = document.createElement("a");
                        editLink.href = `/admin/editCategory/${category._id}?page=${currentPage}`;
                        editLink.className = "btn btn-edit";
                        editLink.textContent = "Edit";

                        const deletBtn = document.createElement("button");
                        deletBtn.className = "btn btn-delete";
                        deletBtn.textContent = "Delete";
                        deletBtn.setAttribute("data-id", category._id);
                        deletBtn.setAttribute("data-page", currentPage);

                        actionTd.appendChild(editLink);
                        actionTd.appendChild(deletBtn);

                        tr.appendChild(actionTd);
                        tbody.appendChild(tr);
                    });
                }



                async function deleteCategory(id, page) {
                    try {

                        const response = await fetch(`/admin/categories/${id}`, { method: "PUT" });
                        console.log(response);

                        if (!response.ok) {
                            throw new Error("Network response was not ok");
                        }
                        const data = await response.json();

                        Swal.fire({
                            icon: "success",
                            text: "Category deleted successfully!"
                        });

                        await fetchCategory(page, "");

                    } catch (error) {

                        console.error("Error deleting category:", error);
                        Swal.fire({
                            icon: "error",
                            text: "Failed to delete category"
                        });
                    }
                }

                function renderPagination(totalPages, currentPage) {
                    console.log("get in to renderPagination");

                    const pagination = document.querySelector(".pagination");
                    pagination.innerHTML = "";

                    if (currentPage > 1) {
                        const prevBtn = document.createElement("button");
                        prevBtn.textContent = "<<";
                        prevBtn.className = "pagination-btn";
                        search = searchInput.value;
                        prevBtn.onclick = () => fetchCategory(currentPage - 1, search);
                        pagination.appendChild(prevBtn);
                    }
                    for (let i = 1; i <= totalPages; i++) {
                        const pageBtn = document.createElement("button");
                        pageBtn.textContent = i;
                        pageBtn.className = "pagination-btn";
                        if (i === currentPage) {
                            pageBtn.classList.add("active");
                        } search = searchInput.value;
                        pageBtn.onclick = () => fetchCategory(i, search);
                        pagination.appendChild(pageBtn);
                    }
                    console.log("total page:", totalPages);
                    if (currentPage < totalPages) {
                        const nextBtn = document.createElement("button");
                        nextBtn.textContent = ">>";
                        nextBtn.className = "pagination-btn";
                        search = searchInput.value;
                        nextBtn.onclick = () => fetchCategory(currentPage + 1, search);
                        pagination.appendChild(nextBtn);
                    }
                }
            });





        </script>