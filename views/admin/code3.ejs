<!-- views/addProduct.ejs -->
<%- include("../partials/admin/header") %>

    <head>
        <link rel="stylesheet" href="/css/sidebar.css">
        <link rel="stylesheet" href="/css/products.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
        <link rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/0.9.15/css/bootstrap-multiselect.css">
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/0.9.15/js/bootstrap-multiselect.min.js">
            </script>

    </head>



    <div class="container">
        <!-- Sidebar -->
        <%- include("../partials/admin/sidebar") %>

            <body>
                <!-- Main Content -->
                <div class="main">
                    <h1>Add New Product</h1>

                    <div class="form-container">
                        <h2>Product Information</h2>
                        <form id="productForm" action="/admin/product" method="POST" enctype="multipart/form-data">

                            <!-- Product Name -->
                            <div class="form-group">
                                <label for="productName">Product Name</label>
                                <input type="text" id="productName" name="name" class="form-control">
                                <div id="nameError" class="error-message"></div>
                            </div>

                            <!-- Category Dropdown -->
                            <div class="form-group">
                                <label for="category">Category</label>
                                <select id="category" name="category[]" class="form-control" multiple>
                                    <% if (categories && categories.length> 0) { %>
                                        <% categories.forEach(category=> { %>
                                            <option value="<%= category._id %>">
                                                <%= category.name %>
                                            </option>
                                            <% }) %>
                                                <% } else { %>
                                                    <option disabled>No categories available</option>
                                                    <% } %>
                                </select>
                                <div id="categoryError" class="error-message"></div>
                            </div>

                            <!-- Brand -->
                            <div class="form-group">
                                <label for="brand">Brand</label>
                                <select name="brand" id="brand" class="form-control">
                                    <option value="">Select Brand</option>
                                    <% if (brands && brands.length> 0) { %>
                                        <% brands.forEach(brand=> { %>
                                            <option value="<%= brand._id %>">
                                                <%= brand.name %>
                                            </option>
                                            <% }) %>
                                                <% } %>
                                </select>
                                <div id="brandError" class="error-message"></div>
                            </div>

                            <!-- Description -->
                            <div class="form-group">
                                <label for="description">Description</label>
                                <textarea id="description" name="description" class="form-control"></textarea>
                            </div>

                            <!-- Product Variants -->
                            <div class="form-group">
                                <label>Product Variants</label>
                                <button type="button" class="add-variant-btn" id="addVariantBtn">+ Add Variant</button>
                                <div id="variantsContainer">
                                    <!-- Variants will be added here dynamically -->
                                </div>
                            </div>

                            <!-- Actions -->
                            <div class="form-group">
                                <button type="submit" class="btn btn-primary">Save Product</button>
                                <button type="button" class="btn btn-outline"
                                    onclick="window.history.back()">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            </body>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <!-- Initialize Multiselect -->
    <script>
        $(document).ready(function () {
            $('#category').multiselect({
                includeSelectAllOption: true,
                enableFiltering: true,
                buttonWidth: '100%'
            });
        });
    </script>

    <!-- Main Script -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {

            const message = "<%= message %>";
            const type = "<%= type %>";
            if (message) {
                Swal.fire({
                    icon: type,
                    text: message,
                    confirmButtonColor: '#007bff'
                });
            }

            const form = document.getElementById("productForm");
            const nameInput = document.getElementById("productName");
            const nameError = document.getElementById("nameError");
            const categoryInput = document.getElementById("category");
            const categoryError = document.getElementById("categoryError");
            const brandInput = document.getElementById("brand");
            const brandError = document.getElementById("brandError");
            const descriptionInput = document.getElementById("description");
            const addVariantBtn = document.getElementById("addVariantBtn");
            const variantsContainer = document.getElementById("variantsContainer");

            let variantCount = 0; // Counter for variants
            let allVariants = []; // Array to store variant data
            let variantImages = {};

            addNewVariant();

            addVariantBtn.addEventListener("click", function () {
                addNewVariant();
            });

            // Add Variant Function
            function addNewVariant() {
                variantCount++;
                const variantId = `variant-${variantCount}`;

                const variantHtml = `
        <div class="variant" id="${variantId}">
          <div class="variant-header"> 
            <hr class="variant-divider">
            <h4>Variant ${variantCount}</h4>
            <button type="button" class="remove-variant" data-variant-id="${variantId}">Remove Variant</button>
          </div>
          
          <div class="variant-content">
            <!-- Strap Color -->
            <div class="form-group">
              <label for="strap_color-${variantCount}">Strap Color</label>
              <input type="text" id="strap_color-${variantCount}" name="variants[${variantCount}][strap_color]" class="form-control variant-strap_color">
              <div class="strap_color-error error-message"></div>
            </div>

            <!-- Dial Color -->
            <div class="form-group">
              <label for="dial_color-${variantCount}">Dial Color</label>
              <input type="text" id="dial_color-${variantCount}" name="variants[${variantCount}][dial_color]" class="form-control variant-dial_color">
              <div class="dial_color-error error-message"></div>
            </div>

            <!-- Price -->
            <div class="form-group">
              <label for="price-${variantCount}">Price (â‚¹)</label>
              <input type="number" id="price-${variantCount}" name="variants[${variantCount}][price]" class="form-control variant-price" min="1">
              <div class="price-error error-message"></div>
            </div>

            <!-- Stock -->
            <div class="form-group">
              <label for="stock-${variantCount}">Stock Quantity</label>
              <input type="number" id="stock-${variantCount}" name="variants[${variantCount}][stock]" class="form-control variant-stock" min="0">
              <div class="stock-error error-message"></div>
            </div>

            <!-- Images -->
            <div class="form-group">
              <label for="images-${variantCount}">Product Images</label>
              <input type="file" id="images-${variantCount}" name="variants[${variantCount}][images]" class="variant-images" accept="image/*">
              <div class="images-error error-message"></div>
              
              <!-- Image preview area -->
              <div id="modal-${variantCount}">
                <div id="modalContent">
                  <img id="preview-${variantCount}" style="width: 500px; height: 500px; display: none;">
                  <button id="cropBtn-${variantCount}" type="button" style="display: none;">Crop</button>
                  <button id="closeBtn-${variantCount}" style="display: none;">Close</button>
                </div>
              </div>
              
              <!-- Cropped images gallery -->
              <div id="croppedGallery-${variantCount}" style="display:flex; gap:10px; flex-wrap:wrap;"></div>
            </div>
          </div>
        </div>`;

                variantsContainer.insertAdjacentHTML('beforeend', variantHtml);

                const removeBtn = document.querySelector(`[data-variant-id="${variantId}"]`);
                removeBtn.addEventListener("click", () => removeVariant(variantId));

                addImage(variantCount);
            }

            // Remove Variant
            function removeVariant(id) {
                const variable = document.getElementById(id);
                if (variable) {
                    variable.remove();
                }
                allVariants = allVariants.filter(variant => variant.id !== id);
            }

            // Image Cropper
            function addImage(variantCount) {
                const imgElement = document.getElementById(`images-${variantCount}`);
                const modal = document.getElementById(`modal-${variantCount}`);
                const previewImg = document.getElementById(`preview-${variantCount}`);
                const cropBtn = document.getElementById(`cropBtn-${variantCount}`);
                const closeBtn = document.getElementById(`closeBtn-${variantCount}`);
                const croppedGallery = document.getElementById(`croppedGallery-${variantCount}`);

                let cropper;
                let canvas;
                let imageCount = 0;

                imgElement.addEventListener("change", (event) => {
                    const selectedImg = event.target.files[0];
                    if (selectedImg) {
                        previewImg.src = URL.createObjectURL(selectedImg);
                        modal.style.display = "flex";
                        previewImg.style.display = "block";
                        cropBtn.style.display = "inline";
                        closeBtn.style.display = "inline";

                        if (cropper) cropper.destroy();

                        cropper = new Cropper(previewImg, {
                            aspectRatio: 1,
                            viewMode: 1,
                            autoCropArea: 0.8
                        });
                    }
                });

                cropBtn.addEventListener("click", () => {
                    if (cropper) {
                        canvas = cropper.getCroppedCanvas({
                            width: 500,
                            height: 500,
                            imageSmoothingQuality: 'high'
                        });
                    }

                    imageCount++;

                    const croppedImg = document.createElement("img");
                    croppedImg.src = canvas.toDataURL("image/png");
                    croppedImg.style.width = "100px";
                    croppedImg.style.height = "100px";
                    croppedImg.style.border = "2px solid #ccc";
                    croppedImg.style.borderRadius = "6px";

                    canvas.toBlob((blob) => {
                        const file = new File([blob], `cropped_${Date.now()}.png`, { type: "image/png" });
                        if (!variantImages[variantCount]) variantImages[variantCount] = [];
                        variantImages[variantCount].push(file);
                    });

                    // Clear button
                    const clearBtn = document.createElement("span");
                    clearBtn.id = `clearBtn-${imageCount}`;
                    clearBtn.textContent = "x";
                    clearBtn.style.position = "absolute";
                    clearBtn.style.top = "2px";
                    clearBtn.style.right = "6px";
                    clearBtn.style.cursor = "pointer";
                    clearBtn.style.color = "red";
                    clearBtn.style.fontWeight = "bold";
                    clearBtn.style.fontSize = "18px";
                    clearBtn.style.background = "white";
                    clearBtn.style.borderRadius = "50%";
                    clearBtn.style.padding = "0 6px";

                    const imgWrapper = document.createElement("div");
                    imgWrapper.style.position = "relative";
                    imgWrapper.style.display = "inline-block";
                    imgWrapper.style.margin = "5px";

                    imgWrapper.appendChild(croppedImg);
                    imgWrapper.appendChild(clearBtn);
                    croppedGallery.appendChild(imgWrapper);

                    clearBtn.addEventListener("click", () => {
                        imgWrapper.remove();
                        variantImages[variantCount].splice(imageCount - 1, 1);
                    });

                    cropper.destroy();
                    cropper = null;

                    previewImg.style.display = "none";
                    cropBtn.style.display = "none";
                    closeBtn.style.display = "none";
                    modal.style.display = "none";
                });

                closeBtn.addEventListener("click", () => {
                    previewImg.style.display = "none";
                    cropBtn.style.display = "none";
                    closeBtn.style.display = "none";
                    modal.style.display = "none";
                    if (cropper) cropper.destroy();
                });
            }

            // Form Submit
            form.addEventListener("submit", async function (e) {
                e.preventDefault();
                try {
                    const formData = new FormData();

                    formData.append("name", e.target.name.value);
                    formData.append("category", e.target.category.value);
                    formData.append("brand", e.target.brand.value);
                    formData.append("description", e.target.description.value);

                    const variants = document.querySelectorAll(".variant");

                    variants.forEach((variant, index) => {
                        const strapColor = variant.querySelector(".variant-strap_color").value;
                        const dialColor = variant.querySelector(".variant-dial_color").value;
                        const price = variant.querySelector(".variant-price").value;
                        const stock = variant.querySelector(".variant-stock").value;

                        formData.append(`variants[${index}][strap_color]`, strapColor);
                        formData.append(`variants[${index}][dial_color]`, dialColor);
                        formData.append(`variants[${index}][price]`, price);
                        formData.append(`variants[${index}][stock]`, stock);

                        const images = variantImages[index + 1] || [];
                        images.forEach((image) => {
                            formData.append(`variants[${index}][images]`, image);
                        });
                    });

                    const response = await fetch("/admin/product", {
                        method: "POST",
                        body: formData
                    });

                    if (!response.ok) throw new Error("Network response was not ok");
                    const data = await response.json();

                    Swal.fire({
                        icon: data.type || "error",
                        text: data.message || "Something went wrong",
                        confirmButtonColor: '#007bff'
                    });

                    if (data.success) {
                        window.location.href = "/admin/products";
                    }

                } catch (error) {
                    console.error("Form submit error:", error);
                }
            });

        });
    </script>