<!-- views/addProduct.ejs -->
<%- include("../partials/admin/header") %>

    <head>
        <link rel="stylesheet" href="/css/sidebar.css">
        <link rel="stylesheet" href="/css/products.css">
    </head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">

    

    <div class="container">
        <!-- Sidebar -->
        <%- include("../partials/admin/sidebar") %>

            </head>

            <body>

                <!-- Main Content -->
                <div class="main">
                    <h1>Add New Product</h1>

                    <div class="form-container">
                        <h2>Product Information</h2>
                        <form id="productForm" action="/admin/product" method="POST" enctype="multipart/form-data">

                            <!-- Product Name -->
                            <div class="form-group">
                                <label for="productName">Product Name</label>
                                <input type="text" id="productName" name="name" class="form-control">
                                <div id="nameError" class="error-message"></div>
                            </div>

                            <!-- Category Dropdown -->
                            <div class="form-group">
                                <label for="category">Category</label>
                                <select id="category" name="category" class="form-control">
                                    <option value="">Select Category</option>
                                    <% if (categories && categories.length> 0) { %>
                                        <% categories.forEach(category=> { %>
                                            <option value="<%= category._id %>">
                                                <%= category.name %>
                                            </option>
                                            <% }) %>
                                                <% } else { %>
                                                    <option disabled>No categories available</option>
                                                    <% } %>
                                </select>
                                <div id="categoryError" class="error-message"></div>
                            </div>

                            <!-- Brand -->
                            <div class="form-group">
                                <label for="brand">Brand</label>
                                <select name="brand" id="brand" class="form-control">
                                    <option value="">Select Brand</option>
                                    <% if (brands && brands.length> 0) { %>
                                        <% brands.forEach(brand=> { %>
                                            <option value="<%= brand._id %>">
                                                <%= brand.name %>
                                            </option>
                                            <% }) %>
                                                <% } %>
                                </select>
                                <div id="brandError" class="error-message"></div>

                            </div>

                            <!-- Description -->
                            <div class="form-group">
                                <label for="description">Description</label>
                                <textarea id="description" name="descrip" class="form-control"></textarea>
                            </div>

                            <!-- Price -->
                            <!--
                <div class="form-group">
                    <label for="price">Price (₹)</label>
                    <input type="number" id="price" name="price" step="0.01" min="0" class="form-control" required>
                </div>
                -->

                            <!-- Image Upload -->
                            <div class="form-group">
                                <label for="productImage">Product Image (max 4 images)</label>
                                <input type="file" id="file" name="productImages" accept="image/*">
                                <div id="modal">
                                    <div id="modalContent">
                                        <img id="preview" style="width: 500px; height: 500px; display: none;">
                                        <button id="cropBtn" type="button" style="display: none;">Crop</button>
                                        <button id="closeBtn" style="display: none;">Close</button>
                                    </div>
                                </div>
                                <div>
                                    <!-- Cropped images gallery -->
                                    <div id="croppedGallery" style="display:flex; gap:10px; flex-wrap:wrap;"></div>
                                </div>
                            </div>
                    </div>

                    <!-- Variants -->
                    <!--
                    <div class="form-group">
                        <label>Product Variants</label>
                        <button type="button" class="add-variant-btn" id="addVariantBtn">+ Add Variant</button>

                        <div id="variantsContainer">
                    -->
                    <!-- Variants will be added here dynamically -->

                </div>
    </div>

    <!-- Actions -->
    <div class="form-group">
        <button type="submit" class="btn btn-primary">Save Product</button>
        <button type="button" class="btn btn-outline" onclick="window.history.back()">Cancel</button>
    </div>
    </form>
    </div>
    </div>

    </body>

    </html>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const message = "<%= message %>";
            const type = "<%= type %>";
            if (message) {
                Swal.fire({
                    icon: type,
                    text: message,
                    confirmButtonColor: '#007bff'
                });
                
            }

            const productName = document.getElementById("productName");
            const nameError = document.getElementById("nameError");
            productName.addEventListener("blur", async (event) => {
                if (event.target.value) {
                    const exists = await checkProductName(productName.value.trim());
                    if (exists) {
                        nameError.textContent = "Product Name already exists. Please change";
                    }
                    else {
                        nameError.textContent = "";
                    }
                }
            });

            productName.addEventListener("focus", () => {
                nameError.textContent = "";

            })

            const imageInput = document.getElementById("file");
            imageInput.addEventListener("change", function (event) {
                if (event.target.files.length > 4) {
                    Swal.fire({
                        icon: "error",
                        text: "You can upload only upto 4 images",
                        confirmButtonColor: '#007bff'
                    });
                    event.target.value = "";
                }
            });

            //         const addVariantBtn = document.getElementById("addVariantBtn");
            //         const variantsContainer = document.getElementById("variantsContainer");
            //         let variantCount = 0;
            //         addVariantBtn.addEventListener("click", function () {
            //             variantCount++;
            //             const variantHtml = `<div class="variants" id="variant-${variantCount}">
            //     <div class="variant-header" >
            //         <hr class="variant-divider">
            //         <button type="button" class="remove-variant">Remove</button>
            //     </div>
            //     <div class="variant-content">
            //         <div class="form-group">
            //                 <label for="variantColor">Color</label>
            //                 <input type="text" id="color" name="variants[${variantCount}][color]" class="form-control" required>
            //             </div>

            //             <div class="form-group">
            //                 <label for="variantImage">Product Image (max 4 images)</label>
            //                 <input type="file" id="variantImage" name="variantImages[]" class="form-control" accept="image/*" multiple>
            //             </div>


            //             <div class="form-group">
            //                 <label for="variantPrice">Price (₹)</label>
            //                 <input type="number" id="variantPrice" name="variants[${variantCount}][price]" class="form-control" required>
            //             </div>
            //             <div class="form-group">
            //                 <label for="variantDisPrice">Discount Price (₹)</label>
            //                 <input type="number" id="variantDisPrice" name="variants[${variantCount}][discPrice]" class="form-control" required>
            //             </div>
            //             <div class="form-group">
            //                 <label for="VariantStock">Stock</label>
            //                 <input type="number" id="VariantStock" name="variants[${variantCount}][stock]" class="form-control" required>
            //             </div>
            //     </div>

            // </div>`;
            //             variantsContainer.insertAdjacentHTML('beforeend', variantHtml);

            //             const newVariant = document.getElementById(`variant-${variantCount}`);
            //             newVariant.querySelector(".remove-variant").addEventListener("click", function () {
            //                 newVariant.remove();
            //             })
            //         })

            const fileInput = document.getElementById("file");
            const modal = document.getElementById("modal");
            const preview = document.getElementById("preview");
            const cropBtn = document.getElementById("cropBtn");
            const closeBtn = document.getElementById("closeBtn");
            const croppedGallery = document.getElementById("croppedGallery");

            let cropper;
            let canvas;

            let croppedFiles = [];


            fileInput.addEventListener("change", function (event) {
                selecetdImg = event.target.files[0];
                if (selecetdImg) {
                    const imageUrl = URL.createObjectURL(selecetdImg);
                    preview.src = imageUrl;
                    preview.style.display = "block";
                    modal.style.display = "flex";
                    cropBtn.style.display = "inline";
                    closeBtn.style.display = "inline";

                    if (cropper) {
                        cropper.destroy();
                    }

                    cropper = new Cropper(preview, {
                        aspectRatio: 1,
                        viewMode: 1,
                        autoCropArea: 0.8
                    });
                }
            });

            cropBtn.addEventListener("click", () => {
                if (cropper) {
                    canvas = cropper.getCroppedCanvas({
                        width: 500,
                        height: 500
                    });
                }

                const imgWrapper = document.createElement("div");
                imgWrapper.style.position = "relative";
                imgWrapper.style.display = "inline-block";
                imgWrapper.style.margin = "5px";

                const croppedImg = document.createElement("img");
                croppedImg.src = canvas.toDataURL("image/png");
                croppedImg.style.width = "150px";
                croppedImg.style.height = "150px";
                croppedImg.style.border = "2px solid #ccc";
                croppedImg.style.borderRadius = "6px";

                const clearBtn = document.createElement("span")
                clearBtn.textContent = "x";
                clearBtn.style.position = "absolute";
                clearBtn.style.top = "2px";
                clearBtn.style.right = "6px";
                clearBtn.style.cursor = "pointer";
                clearBtn.style.color = "red";
                clearBtn.style.fontWeight = "bold";
                clearBtn.style.fontSize = "18px";
                clearBtn.style.background = "white";
                clearBtn.style.borderRadius = "50%";
                clearBtn.style.padding = "0 6px";

                croppedGallery.appendChild(croppedImg);

                canvas.toBlob((blob) => {
                    const file = new File([blob], "cropped.png", { type: "image/png" });
                    croppedFiles.push(file);
                });

                clearBtn.addEventListener("click", () => {
                    imgWrapper.remove();
                })

                imgWrapper.appendChild(croppedImg);
                imgWrapper.appendChild(clearBtn);
                croppedGallery.appendChild(imgWrapper);

                preview.style.display = "none";
                modal.style.display = "none";
                cropBtn.style.display = "none";
                closeBtn.style.display = "none";

                cropper.destroy();
                cropper = null;
            });

            closeBtn.addEventListener("click", () => {
                modal.style.display = "none";
                preview.style.display = "none";
                cropBtn.style.display = "none";
                closeBtn.style.display = "none";
                if (cropper) cropper.destroy();
            });


            const form = document.getElementById("productForm");
            const categoryInput = document.getElementById("category");
            const categoryError = document.getElementById("categoryError");
            const brandInput = document.getElementById("brand");
            const brandError = document.getElementById("brandError");
            categoryInput.addEventListener("focus", () => {
                categoryError.textContent = "";

            })

            brandInput.addEventListener("focus", () => {
                brandError.textContent = "";

            })

            form.addEventListener("submit", (e) => {
                e.preventDefault();
                let valid = true;

                if (productName.value == "") {
                    nameError.textContent = "Please enter Product name";
                    valid = false;
                }

                if (categoryInput.value == "") {
                    categoryError.textContent = "Please select a Category";
                    valid = false;
                }

                if (brandInput.value == "") {
                    brandError.textContent = "Please select a Brand";
                    valid = false;
                }

                if (!valid) {
                    return;
                }


                if (croppedFiles.length > 0) {
                    // stop the default submit for a moment
                    const dataTransfer = new DataTransfer();

                    // add all cropped files
                    croppedFiles.forEach((file, index) => {
                        // give unique names to avoid overwriting
                        const renamedFile = new File([file], `cropped-${index}.png`, { type: "image/png" });
                        dataTransfer.items.add(renamedFile);
                    });

                    // attach to the file input
                    fileInput.files = dataTransfer.files;

                    // now submit the form
                }
                form.submit();
            });


        })

        async function checkProductName(name) {
            try {
                const response = await fetch(`/admin/fetchProduct/${name}`)
                console.log(response);
                if (!response.ok) {
                    throw new Error("Network response was not ok");
                }
                const data = await response.json();
                return data.exists;
            } catch (error) {
                console.log("Failed to get response");
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to get response'
                });
            }

        }

    </script>