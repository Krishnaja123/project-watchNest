<%- include("../partials/user/header") %>

    <head>
        <link rel="stylesheet" href="/css/user/products.css">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    </head>

    <body>

        <div class="container mt-4">
            <div class="row">

                <!-- SIDEBAR -->
                <aside class="col-md-3 col-lg-2 border-end">
                    <h6 class="fw-bold mb-3">Categories</h6>

                    <button class="btn btn-outline-warning w-100 mb-3 rounded-pill" id="clear-filter">Clear
                        Filters</button>

                    <!-- Shop For -->
                    <div class="mb-4">
                        <h6 class="text-uppercase small">Shop For</h6>


                        <% categories.forEach(cat=> { %>
                            <div class="form-check">
                                <input class="form-check-input category-filter" type="checkbox" value="<%= cat._id %>">
                                <label class="form-check-label">
                                    <%= cat.name %>
                                </label>
                            </div>
                            <% }) %>

                    </div>

                    <!-- Brand -->
                    <div class="mb-4">
                        <h6 class="text-uppercase small">Brand</h6>
                        <% brands.forEach(brand=> { %>
                            <div class="form-check">
                                <input class="form-check-input brand-filter" type="checkbox" value="<%= brand._id %>">
                                <label class="form-check-label">
                                    <%= brand.name %>
                                </label>
                            </div>
                            <% }) %>
                    </div>

                    <!-- Price -->
                    <div class="mb-4">
                        <h6 class="text-uppercase small">Price</h6>

                        <div class="d-flex gap-2">
                            <input type="number" id="minPrice" class="form-control" placeholder="Min ₹">
                            <input type="number" id="maxPrice" class="form-control" placeholder="Max ₹">
                        </div>

                        <button id="applyPrice" class="apply-btn w-100 mt-2">Apply</button>
                    </div>

                </aside>

                <!-- MAIN CONTENT -->
                <main class="col-md-9 col-lg-10">

                    <!-- HEADER -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="fw-bold" style="color:#333;">Our Collection</h4>

                        <select id="sortSelect" class="form-select w-auto">
                            <option value="" disabled selected>Sort</option>
                            <option value="low-high">Price: Low to High</option>
                            <option value="high-low">Price: High to Low</option>
                            <option value="newest">Newest</option>
                        </select>
                    </div>

                    <!-- BANNER IMAGE -->
                    <% if (banner) { %>
                        <div class="mb-4">
                            <img src="" class="img-fluid rounded w-100">
                        </div>
                        <% } %>

                            <!-- PRODUCTS GRID -->
                            <div class="products-wrapper">
                                <%- include("../partials/user/productSection", { variants, currentPage, totalPages }) %>
                            </div>

                </main>
            </div>
        </div>

        <%- include("../partials/user/footer") %>

            <script>
                const categoryCheckboxes = document.querySelectorAll('.category-filter');
                const brandCheckboxes = document.querySelectorAll('.brand-filter');
                const productsWrapper = document.querySelector('.products-wrapper');

                const minPriceInput = document.getElementById("minPrice");
                const maxPriceInput = document.getElementById("maxPrice");
                const applyPriceBtn = document.getElementById("applyPrice");

                const sortSelect = document.getElementById("sortSelect");

                async function applyFilters(page = 1) {

                    const categories = [...categoryCheckboxes]
                        .filter(cb => cb.checked)
                        .map(cb => cb.value);

                    const brands = [...brandCheckboxes]
                        .filter(cb => cb.checked)
                        .map(cb => cb.value);

                    const minPrice = minPriceInput.value || 0;
                    const maxPrice = maxPriceInput.value || Infinity;

                    const sort = sortSelect.value;

                    const params = new URLSearchParams();

                    if (categories.length) {
                        params.append("category", categories.join(","));
                    }

                    if (brands.length) {
                        params.append("brand", brands.join(","));
                    }

                    if (minPrice) {
                        params.append("minPrice", minPrice);
                    }

                    if (maxPrice) {
                        params.append("maxPrice", maxPrice);
                    }

                    if (sort) {
                        params.append("sort", sort);
                    }

                    params.append("page", page);
                    params.append("limit", 12);

                    const response = await fetch(`/products/filter?${params.toString()}`)
                    const html = await response.text();
                    console.log(params);

                    productsWrapper.innerHTML = html;

                }

                categoryCheckboxes.forEach(cb => cb.addEventListener('change', applyFilters));
                brandCheckboxes.forEach(cb => cb.addEventListener('change', applyFilters));

                applyPriceBtn.addEventListener("click", applyFilters);

                sortSelect.addEventListener("change", applyFilters);

                const clearFilter = document.getElementById("clear-filter");
                clearFilter.addEventListener('click', async () => {
                    categoryCheckboxes.forEach(cb => cb.checked = false);
                    brandCheckboxes.forEach(cb => cb.checked = false);
                    minPriceInput.value = "";
                    maxPriceInput.value = "";
                    sortSelect.selectedIndex = 0;

                    const response = await fetch('/products/filter');
                    const html = await response.text();

                    productsWrapper.innerHTML = html;
                })

                document.addEventListener("click", function (e) {
                    if (e.target.classList.contains("pagination-btn")) {

                        const page = e.target.dataset.page;

                        document.querySelectorAll(".page-item")
                            .forEach(item => item.classList.remove("active"));

                        e.target.closest(".page-item").classList.add("active");

                        applyFilters(page);
                    }
                })

            </script>

    </body>

    </html>